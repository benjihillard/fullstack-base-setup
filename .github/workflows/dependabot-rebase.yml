name: Dependabot Rebase

on:
  # 1. Trigger via comment
  issue_comment:
    types:
      - created
      
  # 2. Trigger via manual dispatch
  workflow_dispatch:
    inputs:
      pull_request_number:
        description: 'The number of the PR to rebase'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  rebase:
    # Run if triggered by a valid comment OR a manual dispatch
    if: |
      (github.event_name == 'workflow_dispatch') || 
      (
        github.event.issue.pull_request &&
        github.actor != 'dependabot[bot]' &&
        contains(github.event.comment.body, '/dependabot-rebase')
      )
    runs-on: ubuntu-latest
    
    steps:
      # --- FIX 1 ---
      # You MUST check out the repo first so the 'gh' command has context.
      - name: Checkout Repo
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up PR variables
        id: setup
        run: |
          if [ "${{ github.event_name }}" == "issue_comment" ]; then
            echo "PR_NUMBER=${{ github.event.issue.pull_request.number }}" >> $GITHUB_ENV
            echo "PR_REF=${{ github.event.issue.pull_request.head.ref }}" >> $GITHUB_ENV
            echo "BASE_REF=${{ github.event.issue.pull_request.base.ref }}" >> $GITHUB_ENV
            echo "COMMENT_ID=${{ github.event.comment.id }}" >> $GITHUB_ENV
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "PR_NUMBER=${{ github.event.inputs.pull_request_number }}" >> $GITHUB_ENV
            PR_JSON=$(gh pr view ${{ github.event.inputs.pull_request_number }} --json headRefName,baseRefName)
            echo "PR_REF=$(echo $PR_JSON | jq -r .headRefName)" >> $GITHUB_ENV
            echo "BASE_REF=$(echo $PR_JSON | jq -r .baseRefName)" >> $GITHUB_ENV
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --- FIX 2 ---
      # Now, check out the *actual PR branch* to perform the rebase on
      - name: Checkout PR Branch
        uses: actions/checkout@v6
        with:
          ref: ${{ env.PR_REF }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18' # Matches your ci.yml
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Set up Git User
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch Target Branch (main)
        run: |
          git fetch origin ${{ env.BASE_REF }}

      - name: Perform Rebase
        run: |
          git rebase origin/${{ env.BASE_REF }}
        continue-on-error: true # This is correct!

      - name: Install Dependencies to Regenerate Lockfiles
        run: npm run install:all

      - name: Commit and Force-Push Changes
        run: |
          # This is customized to add all package.json and package-lock.json files
          git add package.json package-lock.json frontend/package.json frontend/package-lock.json backend/package.json backend/package-lock.json
          
          # Check if there's anything to commit
          if ! git diff --staged --quiet; then
            # Commit the new lockfiles
            git commit -m "chore: regenerate lockfiles after rebase"
          else
            echo "No lockfile changes to commit."
          fi
          
          # Force-push to the Dependabot branch to overwrite it
          git push --force origin ${{ env.PR_REF }}

      - name: Add Reaction to Comment (if triggered by comment)
        if: github.event_name == 'issue_comment'
        uses: peter-evans/create-or-update-comment@v5
        with:
          comment-id: ${{ env.COMMENT_ID }}
          reactions: rocket # This is the corrected 'reactions' input
